/**
 * Copyright (C)  2011-2011  Jesse Meng (pingf0@gmail.com).
 *
 * This file is part of OOC-GCC.
 *
 * OOC-GCC is free software: you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as published
 * by the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 * See the GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library. If not, see
 * <http://www.gnu.org/licenses/>.
 */

#pragma once
/////////////////////////////////////////////
//class core design
#define __OOC_CLASS__DECLARE_DEFINITIONS(Type) \
	typedef struct _##Type Type; \
	typedef struct _##Type * (*Type##Pt##Fn)(void *,...);

#define __OOC_CLASS__DECLARE_STACK_FUNCTIONS(Type) \
	__OOC_BLOCK__EXTERN_C_BEGIN \
		int ini##Type(struct _##Type * ,void *); \
		int fin##Type(struct _##Type * ,void *); \
	__OOC_BLOCK__EXTERN_C_END

#define __OOC_CLASS__DECLARE_HEAP_FUNCTIONS(Type) \
	__OOC_BLOCK__EXTERN_C_BEGIN \
		struct _##Type * new##Type##Ex(unsigned int,int (*)(struct _##Type *,void *,unsigned int,unsigned int),void *); \
		struct _##Type * new##Type(void *); \
		int del##Type##Ex(struct _##Type **,int (*)(struct _##Type *,void *,unsigned int),void *); \
		int del##Type(struct _##Type **,void *); \
	__OOC_BLOCK__EXTERN_C_END

#define __OOC_CLASS__DECLARE_FUNCTIONS(Type) \
	__OOC_CLASS__DECLARE_STACK_FUNCTIONS(Type)\
	__OOC_CLASS__DECLARE_HEAP_FUNCTIONS(Type)


#define __OOC_CLASS__RAW_DESIGN(Type) \
	__OOC_CLASS__DECLARE_DEFINITIONS(Type) \
	__OOC_CLASS__DECLARE_FUNCTIONS(Type) \
	struct _##Type

//////////////////////////////////////
//ctor&dtor design
#define __OOC_CONSTRUCTOR__CLASS_DESIGN(Type) \
	struct _##Type * new##Type##Ex(unsigned int __OOC_MEMORY_EXTENED,int (*__OOC_EX_FUNCTION)(struct _##Type *,void *,unsigned int,unsigned int),void *__OOC_PARAMETER) { \
		struct _##Type *__OOC_THIS=NULL; \
		int ret_ini=0; \
		__OOC_FUNCTION__NEW_THREAD_LOCK ; \
		__OOC_FUNCTION__PRINT_CLASS ; \
		__OOC_THIS=(struct _##Type*)__OOC_FUNCTION__ALLOC(sizeof(struct _##Type)+(__OOC_MEMORY_EXTENED)); \
		if( NULL==__OOC_THIS ) { \
			__OOC_FUNCTION__NEW_THREAD_UNLOCK ; \
			return NULL; \
		} \
		ret_ini=ini##Type(__OOC_THIS,__OOC_PARAMETER); \
		if(0>ret_ini) { \
			__OOC_FUNCTION__FREE(__OOC_THIS); \
			__OOC_FUNCTION__NEW_THREAD_UNLOCK ; \
			return NULL; \
		} \
		if(NULL!=__OOC_EX_FUNCTION){ \
			if(0>__OOC_EX_FUNCTION(__OOC_THIS,__OOC_PARAMETER,ret_ini,__OOC_MEMORY_EXTENED)){ \
				__OOC_FUNCTION__FREE(__OOC_THIS); \
				__OOC_FUNCTION__NEW_THREAD_UNLOCK ; \
				return NULL; \
			}\
		}\
		__OOC_FUNCTION__NEW_THREAD_UNLOCK ; \
		return __OOC_THIS; \
	} \
	struct _##Type * new##Type(void *__OOC_PARAMETER) { \
		return new##Type##Ex(0,NULL,__OOC_PARAMETER); \
	} \
	int ini##Type(struct _##Type * __OOC_THIS,void *__OOC_PARAMETER)
//
#define __OOC_DESTRUCTOR__CLASS_DESIGN(Type) \
	int del##Type##Ex(struct _##Type **__OOC_THIS_ADDRESS,int (*__OOC_EX_FUNCTION)(struct _##Type *,void *,unsigned int),void *__OOC_PARAMETER) { \
		struct _##Type * __OOC_THIS=*(__OOC_THIS_ADDRESS); \
		int ret_fin=0; \
		__OOC_FUNCTION__DELETE_THREAD_LOCK ; \
		__OOC_FUNCTION__PRINT_CLASS ; \
		if(NULL==__OOC_THIS_ADDRESS||NULL==__OOC_THIS) { \
			__OOC_FUNCTION__DELETE_THREAD_UNLOCK ; \
			return (-1); \
		} \
		ret_fin=fin##Type(*(__OOC_THIS_ADDRESS),__OOC_PARAMETER); \
		if(0>ret_fin) {\
			__OOC_FUNCTION__DELETE_THREAD_UNLOCK ; \
			return (-1); \
		} \
		if(NULL!=__OOC_EX_FUNCTION){ \
			if(0>__OOC_EX_FUNCTION(__OOC_THIS,__OOC_PARAMETER,ret_fin)){ \
			__OOC_FUNCTION__DELETE_THREAD_UNLOCK ; \
				return (-1); \
			}\
		}\
		__OOC_FUNCTION__FREE(*(__OOC_THIS_ADDRESS)); \
		(*(__OOC_THIS_ADDRESS))=NULL; \
		__OOC_FUNCTION__DELETE_THREAD_UNLOCK ; \
		return (0); \
	} \
	int del##Type(struct _##Type **__OOC_THIS_ADDRESS,void *__OOC_PARAMETER) { \
		return del##Type##Ex(__OOC_THIS_ADDRESS,NULL,__OOC_PARAMETER); \
	} \
	int fin##Type(struct _##Type *__OOC_THIS,void *__OOC_PARAMETER)

/////////////////////////////////////////////////////////////
