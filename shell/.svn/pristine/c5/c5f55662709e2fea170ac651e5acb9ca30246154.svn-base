

  Listing 3.3




int
submit_work(void (*func)(void *data), void *data)
{
    struct _mydrv_work *mydrv_work;

    /* Allocate the work structure */
    mydrv_work = kmalloc(sizeof(struct _mydrv_work), GFP_ATOMIC);
    if (!mydrv_work) return -1;

    /* Populate the work structure */
    mydrv_work-&gt;worker_func = func; /* Work function */
    mydrv_work-&gt;worker_data = data; /* Argument to pass */
    spin_lock(&amp;mydrv_wq.lock); /* Protect the list */

    /* Add your work to the tail of the list */
    list_add_tail(&amp;mydrv_work-&gt;mydrv_workitem,
                  &amp;mydrv_wq.mydrv_worklist);

    /* Wake up the worker thread */
    wake_up(&amp;mydrv_wq.todo);
    spin_unlock(&amp;mydrv_wq.lock);

    return 0;
}



syntax highlighted by Code2HTML, v. 0.9.1


lines: 0
