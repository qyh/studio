<html>
<head>
  <title>Listing 7.2</title>
</head>
<body bgcolor="#ffffff" text="#000000">
<pre>

<font color="0000ff"><strong>#include <font color="#008000">&lt;linux/fs.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;asm/uaccess.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;linux/pci.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;linux/input.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;linux/platform_device.h&gt;</font></strong></font>

<strong>struct</strong> <font color="#2040a0">input_dev</font> <font color="4444FF">*</font><font color="#2040a0">vms_input_dev</font><font color="4444FF">;</font>        <font color="#444444">/* Representation of an input device */</font>
<strong>static</strong> <strong>struct</strong> <font color="#2040a0">platform_device</font> <font color="4444FF">*</font><font color="#2040a0">vms_dev</font><font color="4444FF">;</font> <font color="#444444">/* Device structure */</font>

<font color="#444444">/* Sysfs method to input simulated
   coordinates to the virtual
   mouse driver */</font>
<strong>static</strong> <font color="#2040a0">ssize_t</font>
<font color="#2040a0">write_vms</font><font color="4444FF">(</font><strong>struct</strong> <font color="#2040a0">device</font> <font color="4444FF">*</font><font color="#2040a0">dev</font>,
          <strong>struct</strong> <font color="#2040a0">device_attribute</font> <font color="4444FF">*</font><font color="#2040a0">attr</font>,
          <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">buffer</font>, <font color="#2040a0">size_t</font> <font color="#2040a0">count</font><font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
    <strong>int</strong> <font color="#2040a0">x</font>,<font color="#2040a0">y</font><font color="4444FF">;</font>

    <font color="#2040a0">sscanf</font><font color="4444FF">(</font><font color="#2040a0">buffer</font>, <font color="#008000">&quot;%d%d&quot;</font>, <font color="4444FF">&amp;</font><font color="#2040a0">x</font>, <font color="4444FF">&amp;</font><font color="#2040a0">y</font><font color="4444FF">)</font><font color="4444FF">;</font>
    <font color="#444444">/* Report relative coordinates via the
       event interface */</font>
    <font color="#2040a0">input_report_rel</font><font color="4444FF">(</font><font color="#2040a0">vms_input_dev</font>, <font color="#2040a0">REL_X</font>, <font color="#2040a0">x</font><font color="4444FF">)</font><font color="4444FF">;</font>
    <font color="#2040a0">input_report_rel</font><font color="4444FF">(</font><font color="#2040a0">vms_input_dev</font>, <font color="#2040a0">REL_Y</font>, <font color="#2040a0">y</font><font color="4444FF">)</font><font color="4444FF">;</font>
    <font color="#2040a0">input_sync</font><font color="4444FF">(</font><font color="#2040a0">vms_input_dev</font><font color="4444FF">)</font><font color="4444FF">;</font>
    <strong>return</strong> <font color="#2040a0">count</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<font color="#444444">/* Attach the sysfs write method */</font>
<font color="#2040a0">DEVICE_ATTR</font><font color="4444FF">(</font><font color="#2040a0">coordinates</font>, <font color="#FF0000">0644</font>, <font color="#2040a0">NULL</font>, <font color="#2040a0">write_vms</font><font color="4444FF">)</font><font color="4444FF">;</font>

<font color="#444444">/* Attribute Descriptor */</font>
<strong>static</strong> <strong>struct</strong> <font color="#2040a0">attribute</font> <font color="4444FF">*</font><font color="#2040a0">vms_attrs</font><font color="4444FF">[</font><font color="4444FF">]</font> <font color="4444FF">=</font> <font color="4444FF"><strong>{</strong></font>
    <font color="4444FF">&amp;</font><font color="#2040a0">dev_attr_coordinates</font>.<font color="#2040a0">attr</font>,
    <font color="#2040a0">NULL</font>
<font color="4444FF"><strong>}</strong></font><font color="4444FF">;</font>

<font color="#444444">/* Attribute group */</font>
<strong>static</strong> <strong>struct</strong> <font color="#2040a0">attribute_group</font> <font color="#2040a0">vms_attr_group</font> <font color="4444FF">=</font> <font color="4444FF"><strong>{</strong></font>
    .<font color="#2040a0">attrs</font> <font color="4444FF">=</font> <font color="#2040a0">vms_attrs</font>,
<font color="4444FF"><strong>}</strong></font><font color="4444FF">;</font>

<font color="#444444">/* Driver Initialization */</font>
<strong>int</strong> <font color="#2040a0">__init</font>
<font color="#2040a0">vms_init</font><font color="4444FF">(</font><strong>void</strong><font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
    <font color="#444444">/* Register a platform device */</font>
    <font color="#2040a0">vms_dev</font> <font color="4444FF">=</font> <font color="#2040a0">platform_device_register_simple</font><font color="4444FF">(</font><font color="#008000">&quot;vms&quot;</font>, <font color="4444FF">-</font><font color="#FF0000">1</font>, <font color="#2040a0">NULL</font>, <font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">;</font>
    <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">IS_ERR</font><font color="4444FF">(</font><font color="#2040a0">vms_dev</font><font color="4444FF">)</font><font color="4444FF">)</font><font color="4444FF"><strong>{</strong></font>
        <font color="#2040a0">printk</font> <font color="4444FF">(</font><font color="#008000">&quot;vms_init: error<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
        <strong>return</strong> <font color="#2040a0">PTR_ERR</font><font color="4444FF">(</font><font color="#2040a0">vms_dev</font><font color="4444FF">)</font><font color="4444FF">;</font>
    <font color="4444FF"><strong>}</strong></font>

    <font color="#444444">/* Create a sysfs node to read simulated coordinates */</font>
    <font color="#2040a0">sysfs_create_group</font><font color="4444FF">(</font><font color="4444FF">&amp;</font><font color="#2040a0">vms_dev</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">dev</font>.<font color="#2040a0">kobj</font>, <font color="4444FF">&amp;</font><font color="#2040a0">vms_attr_group</font><font color="4444FF">)</font><font color="4444FF">;</font>

    <font color="#444444">/* Allocate an input device data structure */</font>
    <font color="#2040a0">vms_input_dev</font> <font color="4444FF">=</font> <font color="#2040a0">input_allocate_device</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
    <strong>if</strong> <font color="4444FF">(</font><font color="4444FF">!</font><font color="#2040a0">vms_input_dev</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
        <font color="#2040a0">printk</font><font color="4444FF">(</font><font color="#008000">&quot;Bad input_allocate_device()<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font> <strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOMEM</font><font color="4444FF">;</font>
    <font color="4444FF"><strong>}</strong></font>

    <font color="#444444">/* Announce that the virtual mouse will generate
       relative coordinates */</font>
    <font color="#2040a0">set_bit</font><font color="4444FF">(</font><font color="#2040a0">EV_REL</font>, <font color="#2040a0">vms_input_dev</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">evbit</font><font color="4444FF">)</font><font color="4444FF">;</font>
    <font color="#2040a0">set_bit</font><font color="4444FF">(</font><font color="#2040a0">REL_X</font>, <font color="#2040a0">vms_input_dev</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">relbit</font><font color="4444FF">)</font><font color="4444FF">;</font>
    <font color="#2040a0">set_bit</font><font color="4444FF">(</font><font color="#2040a0">REL_Y</font>, <font color="#2040a0">vms_input_dev</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">relbit</font><font color="4444FF">)</font><font color="4444FF">;</font>

    <font color="#444444">/* Register with the input subsystem */</font>
    <font color="#2040a0">input_register_device</font><font color="4444FF">(</font><font color="#2040a0">vms_input_dev</font><font color="4444FF">)</font><font color="4444FF">;</font>

    <font color="#2040a0">printk</font><font color="4444FF">(</font><font color="#008000">&quot;Virtual Mouse Driver Initialized.<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
    <strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<font color="#444444">/* Driver Exit */</font>
<strong>void</strong>
<font color="#2040a0">vms_cleanup</font><font color="4444FF">(</font><strong>void</strong><font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
    <font color="#444444">/* Unregister from the input subsystem */</font>
    <font color="#2040a0">input_unregister_device</font><font color="4444FF">(</font><font color="#2040a0">vms_input_dev</font><font color="4444FF">)</font><font color="4444FF">;</font>

    <font color="#444444">/* Cleanup sysfs node */</font>
    <font color="#2040a0">sysfs_remove_group</font><font color="4444FF">(</font><font color="4444FF">&amp;</font><font color="#2040a0">vms_dev</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">dev</font>.<font color="#2040a0">kobj</font>, <font color="4444FF">&amp;</font><font color="#2040a0">vms_attr_group</font><font color="4444FF">)</font><font color="4444FF">;</font>

    <font color="#444444">/* Unregister driver */</font>
    <font color="#2040a0">platform_device_unregister</font><font color="4444FF">(</font><font color="#2040a0">vms_dev</font><font color="4444FF">)</font><font color="4444FF">;</font>
    <strong>return</strong><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<font color="#2040a0">module_init</font><font color="4444FF">(</font><font color="#2040a0">vms_init</font><font color="4444FF">)</font><font color="4444FF">;</font>
<font color="#2040a0">module_exit</font><font color="4444FF">(</font><font color="#2040a0">vms_cleanup</font><font color="4444FF">)</font><font color="4444FF">;</font>

</pre>
<hr>
syntax highlighted by <a href="http://www.palfrader.org/code2html">Code2HTML</a>, v. 0.9.1
</body>
</html>
