<html>
<head>
  <title>Listing 8.2</title>
</head>
<body bgcolor="#ffffff" text="#000000">
<pre>

<font color="#444444">/* Driver entry points */</font>
<strong>static</strong> <strong>struct</strong> <font color="#2040a0">file_operations</font> <font color="#2040a0">eep_fops</font> <font color="4444FF">=</font> <font color="4444FF"><strong>{</strong></font>
    .<font color="#2040a0">owner</font> <font color="4444FF">=</font> <font color="#2040a0">THIS_MODULE</font>,
    .<font color="#2040a0">llseek</font> <font color="4444FF">=</font> <font color="#2040a0">eep_llseek</font>,
    .<font color="#2040a0">read</font> <font color="4444FF">=</font> <font color="#2040a0">eep_read</font>,
    .<font color="#2040a0">ioctl</font> <font color="4444FF">=</font> <font color="#2040a0">eep_ioctl</font>,
    .<font color="#2040a0">open</font> <font color="4444FF">=</font> <font color="#2040a0">eep_open</font>,
    .<font color="#2040a0">release</font> <font color="4444FF">=</font> <font color="#2040a0">eep_release</font>,
    .<font color="#2040a0">write</font> <font color="4444FF">=</font> <font color="#2040a0">eep_write</font>,
<font color="4444FF"><strong>}</strong></font><font color="4444FF">;</font>

<strong>static</strong> <font color="#2040a0">dev_t</font> <font color="#2040a0">dev_number</font><font color="4444FF">;</font>            <font color="#444444">/* Allotted Device Number */</font>
<strong>static</strong> <strong>struct</strong> <font color="#2040a0">class</font> <font color="4444FF">*</font><font color="#2040a0">eep_class</font><font color="4444FF">;</font>     <font color="#444444">/* Device class */</font>
<font color="#444444">/* Per-device client data structure for each
 * memory bank supported by the driver
 */</font>
<strong>struct</strong> <font color="#2040a0">eep_bank</font> <font color="4444FF"><strong>{</strong></font>
    <strong>struct</strong> <font color="#2040a0">i2c_client</font> <font color="4444FF">*</font><font color="#2040a0">client</font><font color="4444FF">;</font>      <font color="#444444">/* I2C client for this bank */</font>
    <strong>unsigned</strong> <strong>int</strong> <font color="#2040a0">addr</font><font color="4444FF">;</font>              <font color="#444444">/* Slave address of this bank */</font>
    <strong>unsigned</strong> <strong>short</strong> <font color="#2040a0">current_pointer</font><font color="4444FF">;</font> <font color="#444444">/* File pointer */</font>
    <strong>int</strong> <font color="#2040a0">bank_number</font><font color="4444FF">;</font>                <font color="#444444">/* Actual memory bank number */</font>
    <font color="#444444">/* ... */</font>                       <font color="#444444">/* Spinlocks, data cache for
                                       slow devices,.. */</font>
<font color="4444FF"><strong>}</strong></font><font color="4444FF">;</font>

<font color="0000ff"><strong>#define NUM_BANKS 2                <font color="#444444"> /* Two supported banks */</font></strong></font>
<font color="0000ff"><strong>#define BANK_SIZE 2048             <font color="#444444"> /* Size of each bank */</font></strong></font>
<strong>struct</strong> <font color="#2040a0">ee_bank</font> <font color="4444FF">*</font><font color="#2040a0">ee_bank_list</font><font color="4444FF">;</font>       <font color="#444444">/* List of private data
                                       structures, one per bank */</font>

<font color="#444444">/*
 * Device Initialization
 */</font>
<strong>int</strong> <font color="#2040a0">__init</font>
<font color="#2040a0">eep_init</font><font color="4444FF">(</font><strong>void</strong><font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
    <strong>int</strong> <font color="#2040a0">err</font>, <font color="#2040a0">i</font><font color="4444FF">;</font>

    <font color="#444444">/* Allocate the per-device data structure, ee_bank */</font>
    <font color="#2040a0">ee_bank_list</font> <font color="4444FF">=</font> <font color="#2040a0">kmalloc</font><font color="4444FF">(</font><strong>sizeof</strong><font color="4444FF">(</font><strong>struct</strong> <font color="#2040a0">ee_bank</font><font color="4444FF">)</font><font color="4444FF">*</font><font color="#2040a0">NUM_BANKS</font>,
                           <font color="#2040a0">GFP_KERNEL</font><font color="4444FF">)</font><font color="4444FF">;</font>
    <font color="#2040a0">memset</font><font color="4444FF">(</font><font color="#2040a0">ee_bank_list</font>, <font color="#FF0000">0</font>, <strong>sizeof</strong><font color="4444FF">(</font><strong>struct</strong> <font color="#2040a0">ee_bank</font><font color="4444FF">)</font><font color="4444FF">*</font><font color="#2040a0">NUM_BANKS</font><font color="4444FF">)</font><font color="4444FF">;</font>

    <font color="#444444">/* Register and create the /dev interfaces to access the EEPROM
       banks. Refer back to Chapter 5, &quot;Character Drivers&quot; for
       more details */</font>
    <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">alloc_chrdev_region</font><font color="4444FF">(</font><font color="4444FF">&amp;</font><font color="#2040a0">dev_number</font>, <font color="#FF0000">0</font>,
                            <font color="#2040a0">NUM_BANKS</font>, <font color="#008000">&quot;eep&quot;</font><font color="4444FF">)</font> <font color="4444FF">&lt;</font> <font color="#FF0000">0</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
        <font color="#2040a0">printk</font><font color="4444FF">(</font><font color="#2040a0">KERN_DEBUG</font> <font color="#008000">&quot;Can’t register device<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
        <strong>return</strong> <font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">;</font>
    <font color="4444FF"><strong>}</strong></font>

    <font color="#2040a0">eep_class</font> <font color="4444FF">=</font> <font color="#2040a0">class_create</font><font color="4444FF">(</font><font color="#2040a0">THIS_MODULE</font>, <font color="#2040a0">DEVICE_NAME</font><font color="4444FF">)</font><font color="4444FF">;</font>

    <strong>for</strong> <font color="4444FF">(</font><font color="#2040a0">i</font><font color="4444FF">=</font><font color="#FF0000">0</font><font color="4444FF">;</font> <font color="#2040a0">i</font> <font color="4444FF">&lt;</font> <font color="#2040a0">NUM_BANKS</font><font color="4444FF">;</font><font color="#2040a0">i</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
        <font color="#444444">/* Connect the file operations with cdev */</font>
        <font color="#2040a0">cdev_init</font><font color="4444FF">(</font><font color="4444FF">&amp;</font><font color="#2040a0">ee_bank</font><font color="4444FF">[</font><font color="#2040a0">i</font><font color="4444FF">]</font>.<font color="#2040a0">cdev</font>, <font color="4444FF">&amp;</font><font color="#2040a0">ee_fops</font><font color="4444FF">)</font><font color="4444FF">;</font>
        <font color="#444444">/* Connect the major/minor number to the cdev */</font>
        <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">cdev_add</font><font color="4444FF">(</font><font color="4444FF">&amp;</font><font color="#2040a0">ee_bank</font><font color="4444FF">[</font><font color="#2040a0">i</font><font color="4444FF">]</font>.<font color="#2040a0">cdev</font>, <font color="4444FF">(</font><font color="#2040a0">dev_number</font> <font color="4444FF">+</font> <font color="#2040a0">i</font><font color="4444FF">)</font>, <font color="#FF0000">1</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
            <font color="#2040a0">printk</font><font color="4444FF">(</font><font color="#008000">&quot;Bad kmalloc<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
            <strong>return</strong> <font color="#FF0000">1</font><font color="4444FF">;</font>
        <font color="4444FF"><strong>}</strong></font>
        <font color="#2040a0">device_create</font><font color="4444FF">(</font><font color="#2040a0">eep_class</font>, <font color="#2040a0">NULL</font>, <font color="#2040a0">MKDEV</font><font color="4444FF">(</font><font color="#2040a0">MAJOR</font><font color="4444FF">(</font><font color="#2040a0">dev_number</font><font color="4444FF">)</font>, <font color="#2040a0">i</font><font color="4444FF">)</font>,
                      <font color="#008000">&quot;eeprom%d&quot;</font>, <font color="#2040a0">i</font><font color="4444FF">)</font><font color="4444FF">;</font>
    <font color="4444FF"><strong>}</strong></font>

    <font color="#444444">/* Inform the I2C core about our existence. See the section
       &quot;Probing the Device&quot; for the definition of eep_driver */</font>
    <font color="#2040a0">err</font> <font color="4444FF">=</font> <font color="#2040a0">i2c_add_driver</font><font color="4444FF">(</font><font color="4444FF">&amp;</font><font color="#2040a0">eep_driver</font><font color="4444FF">)</font><font color="4444FF">;</font>
    <strong>if</strong> <font color="4444FF">(</font><font color="#2040a0">err</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
        <font color="#2040a0">printk</font><font color="4444FF">(</font><font color="#008000">&quot;Registering I2C driver failed, errno is %d<font color="#77dd77">\n</font>&quot;</font>, <font color="#2040a0">err</font><font color="4444FF">)</font><font color="4444FF">;</font>
        <strong>return</strong> <font color="#2040a0">err</font><font color="4444FF">;</font>
    <font color="4444FF"><strong>}</strong></font>

    <font color="#2040a0">printk</font><font color="4444FF">(</font><font color="#008000">&quot;EEPROM Driver Initialized.<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
    <strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

</pre>
<hr>
syntax highlighted by <a href="http://www.palfrader.org/code2html">Code2HTML</a>, v. 0.9.1
</body>
</html>
