

  Listing 8.2




/* Driver entry points */
static struct file_operations eep_fops = {
    .owner = THIS_MODULE,
    .llseek = eep_llseek,
    .read = eep_read,
    .ioctl = eep_ioctl,
    .open = eep_open,
    .release = eep_release,
    .write = eep_write,
};

static dev_t dev_number;            /* Allotted Device Number */
static struct class *eep_class;     /* Device class */
/* Per-device client data structure for each
 * memory bank supported by the driver
 */
struct eep_bank {
    struct i2c_client *client;      /* I2C client for this bank */
    unsigned int addr;              /* Slave address of this bank */
    unsigned short current_pointer; /* File pointer */
    int bank_number;                /* Actual memory bank number */
    /* ... */                       /* Spinlocks, data cache for
                                       slow devices,.. */
};

#define NUM_BANKS 2                 /* Two supported banks */
#define BANK_SIZE 2048              /* Size of each bank */
struct ee_bank *ee_bank_list;       /* List of private data
                                       structures, one per bank */

/*
 * Device Initialization
 */
int __init
eep_init(void)
{
    int err, i;

    /* Allocate the per-device data structure, ee_bank */
    ee_bank_list = kmalloc(sizeof(struct ee_bank)*NUM_BANKS,
                           GFP_KERNEL);
    memset(ee_bank_list, 0, sizeof(struct ee_bank)*NUM_BANKS);

    /* Register and create the /dev interfaces to access the EEPROM
       banks. Refer back to Chapter 5, &quot;Character Drivers&quot; for
       more details */
    if (alloc_chrdev_region(&amp;dev_number, 0,
                            NUM_BANKS, &quot;eep&quot;) &lt; 0) {
        printk(KERN_DEBUG &quot;Can’t register device\n&quot;);
        return -1;
    }

    eep_class = class_create(THIS_MODULE, DEVICE_NAME);

    for (i=0; i &lt; NUM_BANKS;i++) {
        /* Connect the file operations with cdev */
        cdev_init(&amp;ee_bank[i].cdev, &amp;ee_fops);
        /* Connect the major/minor number to the cdev */
        if (cdev_add(&amp;ee_bank[i].cdev, (dev_number + i), 1)) {
            printk(&quot;Bad kmalloc\n&quot;);
            return 1;
        }
        device_create(eep_class, NULL, MKDEV(MAJOR(dev_number), i),
                      &quot;eeprom%d&quot;, i);
    }

    /* Inform the I2C core about our existence. See the section
       &quot;Probing the Device&quot; for the definition of eep_driver */
    err = i2c_add_driver(&amp;eep_driver);
    if (err) {
        printk(&quot;Registering I2C driver failed, errno is %d\n&quot;, err);
        return err;
    }

    printk(&quot;EEPROM Driver Initialized.\n&quot;);
    return 0;
}



syntax highlighted by Code2HTML, v. 0.9.1


lines: 0
