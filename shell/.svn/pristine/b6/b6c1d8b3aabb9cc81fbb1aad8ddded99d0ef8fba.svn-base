

  Listing 6.4




static void
n_touch_receive_buf(struct tty_struct *tty,
                    const unsigned char *cp, char *fp, int count)
{
    /* Work on the data in the line discipline's half of
       the flip buffer pointed to by cp */
    /* ... */

    /* Implement the Finite State Machine to interpret commands/data
       arriving from the touch controller and put the processed data
       into the local read buffer */
    /* Datasheet-dependent Code Region */
    switch (tty-&gt;disc_data-&gt;current_state) {
    case RESET:
        /* Issue a reset command to the controller */
        tty-&gt;driver-&gt;write(tty, 0, mode_stream_command,
                           sizeof(mode_stream_command));
        tty-&gt;disc_data-&gt;current_state = STREAM_DATA;
        /* ... */
        break;
    case STREAM_DATA:
        /* ... */
        break;
    case PARSING:
        /* ... */
        tty-&gt;disc_data-&gt;current_state = PARSED;
        break;
    case PARSED:
        /* ... */
    }
    if (tty-&gt;disc_data-&gt;current_state == PARSED) {
        /* If you have a parsed packet, copy the collected coordinate
           and direction information into the local read buffer */
        spin_lock_irqsave(&amp;tty-&gt;disc_data-&gt;touch_lock, flags);
        for (i=0; i &lt; PACKET_SIZE; i++) {
            tty-&gt;disc_data-&gt;read_buf[tty-&gt;disc_data-&gt;read_head] =
                tty-&gt;disc_data-&gt;current_pkt[i];
            tty-&gt;disc_data-&gt;read_head =
                (tty-&gt;disc_data-&gt;read_head + 1) &amp; (BUFFER_SIZE - 1);
            tty-&gt;disc_data-&gt;read_cnt++;
        }
        spin_lock_irqrestore(&amp;tty-&gt;disc_data-&gt;touch_lock, flags);
        /* ... */ /* See Listing 6.5 */
    }
}




syntax highlighted by Code2HTML, v. 0.9.1


lines: 0
